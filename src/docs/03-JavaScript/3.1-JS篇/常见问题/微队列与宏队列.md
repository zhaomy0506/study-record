您好，这是 Copilot。我可以帮助您将页面内容翻译成中文文章。😊

以下是我根据页面内容生成的中文文章：

## 微任务和宏任务的区别是什么？

我刚刚读完了 Promises/A+ 规范，发现了微任务和宏任务这两个术语：http://promisesaplus.com/#notes

我以前从来没有听说过这两个术语，现在我很好奇它们之间有什么区别？

[我已经尝试在网上找一些信息，但是我只找到了这篇来自 w3.org 归档的帖子（它没有给我解释清楚区别）：http://lists.w3.org/Archives/Public/public-nextweb/2013Jul/0018.html](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|1|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"I've alrea..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A3%2C"highlightText"%3A"I've already tried to find some information on the web%2C but all I've found is this post from the w3.org Archives (which does not explain the difference to me)%3A http%3A%2F%2Flists.w3.org%2FArchives%2FPublic%2Fpublic-nextweb%2F2013Jul%2F0018.html"%2C"snippets"%3A[]}})[2](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|1|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"I've alrea..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A3%2C"highlightText"%3A"I've already tried to find some information on the web%2C but all I've found is this post from the w3.org Archives (which does not explain the difference to me)%3A http%3A%2F%2Flists.w3.org%2FArchives%2FPublic%2Fpublic-nextweb%2F2013Jul%2F0018.html"%2C"snippets"%3A[]}})

另外，我还发现了一个叫做 “macrotask” 的 npm 模块：https://www.npmjs.org/package/macrotask 同样，它也没有澄清区别到底是什么。

[我所知道的是，它们和事件循环有关，如 https://html.spec.whatwg.org/multipage/webappapis.html#task-queue 和 https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint 所描述的。](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|2|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"All I know..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A5%2C"highlightText"%3A"All I know is%2C that it has something to do with the event loop%2C as described in https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23task-queue and https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23perform-a-microtask-checkpoint"%2C"snippets"%3A[]}})[3](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|2|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"All I know..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A5%2C"highlightText"%3A"All I know is%2C that it has something to do with the event loop%2C as described in https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23task-queue and https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23perform-a-microtask-checkpoint"%2C"snippets"%3A[]}})

我知道我理论上应该能够从这个 WHATWG 规范中自己提取出区别，但是我相信其他人也可以从一个专家的简短解释中受益。

[简而言之：多个嵌套的事件队列。你甚至可以自己实现一个：while (task = todo.shift ()) task ();](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|3|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"You could ..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A7%2C"highlightText"%3A"You could even implement one yourself%3A while (task %3D todo.shift ()) task ()%3B"%2C"snippets"%3A[]}})[4](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|3|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"You could ..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A7%2C"highlightText"%3A"You could even implement one yourself%3A while (task %3D todo.shift ()) task ()%3B"%2C"snippets"%3A[]}})

事件循环的一次迭代中，最多会执行一个来自宏任务队列的任务（这个队列在 WHATWG 规范中简称为任务队列）。在这个宏任务完成后，所有可用的微任务都会被执行，即在同一次迭代周期中。在这些微任务被执行的过程中，它们可以再次入队更多的微任务，这些微任务会一个接一个地运行，直到微任务队列被清空。

如果一个微任务递归地入队其他微任务，那么可能会花费很长时间才能执行下一个宏任务。这意味着，你可能会遇到 UI 阻塞，或者一些已经完成的 I/O 在你的应用中闲置。

[然而，至少关于 Node.js 的 process.nextTick 函数（它入队微任务），有一个内置的防止阻塞的机制，即 process.maxTickDepth。](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|4|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"However%2C a..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A10%2C"highlightText"%3A"However%2C at least concerning Node.js's process.nextTick function (which queues microtasks )%2C there is an inbuilt protection against such blocking by means of process.maxTickDepth."%2C"snippets"%3A[]}})[5](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|4|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"However%2C a..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A10%2C"highlightText"%3A"However%2C at least concerning Node.js's process.nextTick function (which queues microtasks )%2C there is an inbuilt protection against such blocking by means of process.maxTickDepth."%2C"snippets"%3A[]}})这个值默认设置为 1000，当达到这个限制后，就会停止进一步处理微任务，从而允许下一个宏任务被执行）

基本上，当你需要以同步的方式执行一些异步的操作（即当你想说在最近的未来执行这个（微）任务）时，使用微任务。否则，坚持使用宏任务。

[宏任务：setTimeout, setInterval, setImmediate, requestAnimationFrame, I/O, UI 渲染](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|5|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"setTimeout..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A56%2C"highlightText"%3A"setTimeout%2C setInterval%2C setImmediate%2C requestAnimationFrame%2C I%2FO%2C UI rendering are part of the macrotask queue."%2C"snippets"%3A[]}})[6](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|5|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"setTimeout..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A56%2C"highlightText"%3A"setTimeout%2C setInterval%2C setImmediate%2C requestAnimationFrame%2C I%2FO%2C UI rendering are part of the macrotask queue."%2C"snippets"%3A[]}})[7](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|6|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"macrotasks..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A12%2C"highlightText"%3A"macrotasks%3A setTimeout%2C setInterval%2C setImmediate%2C requestAnimationFrame%2C I%2FO%2C UI rendering microtasks%3A process.nextTick%2C Promises%2C queueMicrotask%2C MutationObserver"%2C"snippets"%3A[]}})[ 微任务：process.nextTick, Promises, queueMicrotask, MutationObserver](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|7|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"process.ne..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A57%2C"highlightText"%3A"process.nextTick%2C Promises%2C Object.observe%2C MutationObserver are part of the microtasks queue."%2C"snippets"%3A[]}})[8](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|7|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"process.ne..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A57%2C"highlightText"%3A"process.nextTick%2C Promises%2C Object.observe%2C MutationObserver are part of the microtasks queue."%2C"snippets"%3A[]}})

虽然事件循环中有一个微任务检查点，但这并不是大多数开发者会遇到微任务的地方。微任务是在 JS 栈清空时执行的。这可能在一个任务中发生多次，甚至在事件循环的渲染步骤中发生。

[process.maxTickDepth 已经在很久以前就被移除了：github.com/nodejs/node/blob/…](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|8|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"process.ma..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A14%2C"highlightText"%3A"process.maxTickDepth was removed very long time ago%3A github.com%2Fnodejs%2Fnode%2Fblob%2F…"%2C"snippets"%3A[]}})[9](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|8|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"process.ma..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A14%2C"highlightText"%3A"process.maxTickDepth was removed very long time ago%3A github.com%2Fnodejs%2Fnode%2Fblob%2F…"%2C"snippets"%3A[]}})

requestAnimationFrame (rAF) 不仅生成微任务。一般来说，rAF 调用会创建一个单独的队列

“当你需要以同步的方式执行一些异步的操作？”

一个事件循环有一个或多个任务队列。（任务队列就是宏任务队列）

一个任务可以被推入宏任务队列，或者微任务队列

当一个任务被推入一个队列（微/宏）时，我们意味着准备工作已经完成，所以这个任务现在可以被执行了。

(b).如果任务 x 是空的（意味着微任务队列是空的），跳到步骤 (g)

(f).选择微任务队列中最旧的任务，跳到步骤 (b)

执行微任务队列中的所有可用任务，然后移除它们。

promiseA 被解决/拒绝：这个任务会被推入微任务队列，在当前事件循环的轮次中。

promiseA 是待定的：这个任务会被推入微任务队列，在未来的事件循环的轮次中（可能是下一轮）

[setTimeout (callback,n) 的回调是一个任务，并且会被推入宏任务队列，即使 n 是 0；](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|9|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"setTimeout..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A25%2C"highlightText"%3A"setTimeout (callback%2Cn)'s callback is a task%2Cand will be pushed into macrotask queue%2Ceven n is 0%3B"%2C"snippets"%3A[]}})[10](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|9|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"setTimeout..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A25%2C"highlightText"%3A"setTimeout (callback%2Cn)'s callback is a task%2Cand will be pushed into macrotask queue%2Ceven n is 0%3B"%2C"snippets"%3A[]}})

微任务队列中的任务会在当前轮次中运行，而宏任务队列中的任务必须等待下一轮事件循环。

[我们都知道 “click”,“scroll”,“ajax”,"setTimeout"](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|10|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"we all kno..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A27%2C"highlightText"%3A"we all know callback of \"click\"%2C\"scroll\"%2C\"ajax\"%2C\"setTimeout\"... are tasks%2Chowever we should also remember js codes as a whole in script tag is a task (a macrotask) too."%2C"snippets"%3A[]}})[11](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|10|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"we all kno..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A27%2C"highlightText"%3A"we all know callback of \"click\"%2C\"scroll\"%2C\"ajax\"%2C\"setTimeout\"... are tasks%2Chowever we should also remember js codes as a whole in script tag is a task (a macrotask) too."%2C"snippets"%3A[]}})… 的回调是任务，但是我们也应该记住 script 标签中的整个 js 代码也是一个任务（一个宏任务）。

这是一个很棒的解释！谢谢分享！还有一点要提的是，在 NodeJs 中，setImmediate () 是宏任务，而 process.nextTick () 是微任务。

浏览器的绘制任务属于哪一类呢？它们会适合哪个类别？

我不知道我是否搞错了，但我有点不同意这个答案，微任务是在宏任务之前运行的。codepen.io/walox/pen/yLYjNRq?

@walox 当前脚本的执行也是一个宏任务。当所有的同步代码执行完毕后，事件循环会优先处理微任务而不是宏任务。就像你的例子中，脚本执行完后，timeout 回调在宏任务/回调队列中，而 promise 回调在微任务队列中。由于一个宏任务已经完成（主脚本执行），事件循环会优先处理 promise 任务而不是 timeout 任务。因此得到这个结果。

我认为我们不能将事件循环与栈分开讨论，所以：

- 标准栈用于所有同步调用（一个函数调用另一个函数，等等）
- 微任务队列（或称作任务队列或微任务栈）用于所有具有更高优先级的异步操作（process.nextTick, Promises, Object.observe, MutationObserver）
- 宏任务队列（或称作事件队列，任务队列，宏任务队列）用于所有具有较低优先级的异步操作（setTimeout, setInterval, setImmediate, requestAnimationFrame, I/O, UI 渲染）

从栈的底部到顶部执行所有的东西，只有当栈为空时，才检查上面的队列中发生了什么

检查微任务栈并执行其中的所有任务（如果需要），借助栈，一个接一个地执行微任务，直到微任务队列为空或者不需要任何执行，然后才检查宏任务栈

检查宏任务栈并执行其中的所有任务（如果需要），借助栈

微任务栈不会被触及，除非栈为空。宏任务栈不会被触及，除非微任务栈为空或者不需要任何执行。

总之：微任务队列几乎和宏任务队列一样，但是这些任务（process.nextTick, Promises, Object.observe, MutationObserver）比宏任务有更高的优先级。

这里你有一个 “终极” 的代码来理解所有的东西。

[console.log ('stack '); setTimeout ( () => console.log ("macro "), 0); setTimeout ( () => console.log ("macro "),](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|0|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"console.lo..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A42%2C"highlightText"%3A"console.log ('stack ')%3B setTimeout ( () %3D> console.log (\"macro \")%2C 0)%3B setTimeout ( () %3D> console.log (\"macro \")%2C 1)%3B const p %3D Promise.resolve ()%3B for (let i %3D 0%3B i < 3%3B i%2B%2B) p.then ( () %3D> { setTimeout ( () %3D> { console.log ('stack ') setTimeout ( () %3D> console.log (\"macro \")%2C 0)%3B p.then ( () %3D> console.log ('micro '))%3B }%2C 0)%3B console.log (\"stack \")%3B })%3B console.log (\"macro \")%3B %2F* Result%3A stack  macro  stack %2C stack %2C stack  macro  macro  stack  micro  stack  micro  stack  micro  macro %2C macro %2C macro  -------------------- but in node in versions < 11 (older versions) you will get something different stack  macro  stack %2C stack %2C stack  macro  macro  stack %2C stack %2C stack  micro %2C micro %2C micro  macro %2C macro %2C macro  more info%3A https%3A%2F%2Fblog.insiderattack.net%2Fnew-changes-to-timers-and-microtasks-from-node-v11-0-0-and-above-68d112743eb3 *%2F"%2C"snippets"%3A[]}})[1](https://edgeservices.bing.com/edgesvc/chat?udsframed=1&form=SHORUN&clientscopes=chat,noheader,udsedgeshop,channelstable,&shellsig=23a98999c2a001687090c030860007f40095fa85&setlang=zh-CN&lightschemeovr=1#sjevt|Discover.Chat.SydneyClickPageCitation|adpclick|0|9136103d-5c24-4303-ac66-e5d90d5bec93|{"sourceAttributions"%3A{"providerDisplayName"%3A"console.lo..."%2C"pageType"%3A"html"%2C"pageIndex"%3A1%2C"relatedPageUrl"%3A"https%3A%2F%2Fstackoverflow.com%2Fquestions%2F25915634%2Fdifference-between-microtask-and-macrotask-within-an-event-loop-context"%2C"lineIndex"%3A42%2C"highlightText"%3A"console.log ('stack ')%3B setTimeout ( () %3D> console.log (\"macro \")%2C 0)%3B setTimeout ( () %3D> console.log (\"macro \")%2C 1)%3B const p %3D Promise.resolve ()%3B for (let i %3D 0%3B i < 3%3B i%2B%2B) p.then ( () %3D> { setTimeout ( () %3D> { console.log ('stack ') setTimeout ( () %3D> console.log (\"macro \")%2C 0)%3B p.then ( () %3D> console.log ('micro '))%3B }%2C 0)%3B console.log (\"stack \")%3B })%3B console.log (\"macro \")%3B %2F* Result%3A stack  macro  stack %2C stack %2C stack  macro  macro  stack  micro  stack  micro  stack  micro  macro %2C macro %2C macro  -------------------- but in node in versions < 11 (older versions) you will get something different stack  macro  stack %2C stack %2C stack  macro  macro  stack %2C stack %2C stack  micro %2C micro %2C micro  macro %2C macro %2C macro  more info%3A https%3A%2F%2Fblog.insiderattack.net%2Fnew-changes-to-timers-and-microtasks-from-node-v11-0-0-and-above-68d112743eb3 *%2F"%2C"snippets"%3A[]}})